{
  "hash": "34795d96140b6ea3c9b2150d182eeac7",
  "result": {
    "markdown": "---\ntitle: \"Tidy Tuesday - 12/20\"\nauthor: \"Sam Weiner\"\ndate: last-modified\ncategories: [tidytuesday, analysis]\nfreeze: auto\ndraft: true\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidytuesdayR)\nlibrary(tidyverse)\nlibrary(skimr)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# tt <- tt_load(\"2022-12-20\")\n# \n# tt\n# \n# tt %>% map(glimpse)\n\nweather_forecasts <- read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-12-20/weather_forecasts.csv\")\ncities <- read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-12-20/cities.csv\")\noutlook_meanings <- read_csv(\"https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-12-20/outlook_meanings.csv\")\n\nskim(weather_forecasts)\n```\n\n::: {.cell-output-display}\nTable: Data summary\n\n|                         |                  |\n|:------------------------|:-----------------|\n|Name                     |weather_forecasts |\n|Number of rows           |651968            |\n|Number of columns        |10                |\n|_______________________  |                  |\n|Column type frequency:   |                  |\n|character                |5                 |\n|Date                     |1                 |\n|numeric                  |4                 |\n|________________________ |                  |\n|Group variables          |None              |\n\n\n**Variable type: character**\n\n|skim_variable    | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:----------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|city             |         0|          1.00|   4|  15|     0|      160|          0|\n|state            |         0|          1.00|   2|   2|     0|       53|          0|\n|high_or_low      |         0|          1.00|   3|   4|     0|        2|          0|\n|forecast_outlook |     37875|          0.94|   3|   6|     0|       23|          0|\n|possible_error   |         0|          1.00|   4|  16|     0|        4|          0|\n\n\n**Variable type: Date**\n\n|skim_variable | n_missing| complete_rate|min        |max        |median     | n_unique|\n|:-------------|---------:|-------------:|:----------|:----------|:----------|--------:|\n|date          |         0|             1|2021-01-30 |2022-06-01 |2021-09-30 |      488|\n\n\n**Variable type: numeric**\n\n|skim_variable         | n_missing| complete_rate|  mean|    sd|  p0| p25| p50|   p75|  p100|hist  |\n|:---------------------|---------:|-------------:|-----:|-----:|---:|---:|---:|-----:|-----:|:-----|\n|forecast_hours_before |         0|          1.00| 30.00| 13.42|  12|  21|  30| 39.00|  48.0|▇▇▁▇▇ |\n|observed_temp         |     47744|          0.93| 57.56| 21.81| -47|  42|  59| 74.00| 122.0|▁▁▆▇▁ |\n|forecast_temp         |     37313|          0.94| 57.36| 21.82| -41|  42|  59| 74.00| 118.0|▁▁▆▇▂ |\n|observed_precip       |     50416|          0.92|  0.10|  0.32|   0|   0|   0|  0.02|  12.4|▇▁▁▁▁ |\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n##NEEDS WORK MAYBE DIVE DEEPER INTO ONE RELATIONSHIP\n\nweather_forecasts %>% View()\n\nweather_forecasts %>%\n  filter(!is.na(forecast_temp)) |> \n  filter(state == \"NJ\", city == \"NEWARK\") %>%\n  ggplot() + \n  geom_line(aes(date, forecast_temp), color = \"blue\") + \n  geom_line(aes(date, observed_temp), color = \"red\") +\n  scale_color_brewer() + \n  facet_wrap(~ forecast_hours_before + high_or_low)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 2 rows containing missing values (`geom_line()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nweather_forecasts |> \n  filter(city == \"NEWARK\", state == \"NJ\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3,904 × 10\n   date       city   state high_or_low forecas…¹ obser…² forec…³ obser…⁴ forec…⁵\n   <date>     <chr>  <chr> <chr>           <dbl>   <dbl>   <dbl>   <dbl> <chr>  \n 1 2021-01-30 NEWARK NJ    high               48      34      NA    0    <NA>   \n 2 2021-01-30 NEWARK NJ    high               36      34      NA    0    <NA>   \n 3 2021-01-30 NEWARK NJ    high               24      34      NA    0    <NA>   \n 4 2021-01-30 NEWARK NJ    high               12      34      31    0    SUNNY  \n 5 2021-01-30 NEWARK NJ    low                48      19      NA    0    <NA>   \n 6 2021-01-30 NEWARK NJ    low                36      19      NA    0    <NA>   \n 7 2021-01-30 NEWARK NJ    low                24      19      17    0    SUNNY  \n 8 2021-01-30 NEWARK NJ    low                12      19      17    0    MOCLDY \n 9 2021-01-31 NEWARK NJ    high               48      26      NA    0.41 <NA>   \n10 2021-01-31 NEWARK NJ    high               36      26      30    0.41 MOCLDY \n# … with 3,894 more rows, 1 more variable: possible_error <chr>, and\n#   abbreviated variable names ¹​forecast_hours_before, ²​observed_temp,\n#   ³​forecast_temp, ⁴​observed_precip, ⁵​forecast_outlook\n```\n:::\n\n```{.r .cell-code}\nweather_forecasts |> \n  filter(city == \"NEWARK\", state == \"NJ\", !is.na(forecast_temp)) |> \n  filter(high_or_low == \"high\") |> \n  mutate(error = forecast_temp - observed_temp) |> \n  filter(!is.na(error)) |> \n  group_by(forecast_hours_before) |> \n  summarise(MAE = mean(abs(error)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 2\n  forecast_hours_before   MAE\n                  <dbl> <dbl>\n1                    12  1.97\n2                    24  2.24\n3                    36  2.46\n4                    48  2.60\n```\n:::\n:::\n\n\n## Time Series\n\ntsibble\n\nhow do our predictions using esm or arima do against the national weather service?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tsibble)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'tsibble'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, union\n```\n:::\n\n```{.r .cell-code}\nlibrary(fable)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: fabletools\n```\n:::\n\n```{.r .cell-code}\nlibrary(feasts)\nlibrary(lubridate)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: timechange\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'lubridate'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:tsibble':\n\n    interval\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    date, intersect, setdiff, union\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nforecast_tsbl <- weather_forecasts |>\n  mutate(city = factor(city),\n         state = factor(state),\n         high_or_low = factor(high_or_low),\n         forecast_hours_before = factor(forecast_hours_before)) |> \n  as_tsibble(key = c(city, state, high_or_low, forecast_hours_before), index = date)\n\n\nforecast_tsbl |> group_by_key() |> \n  slice(n()-12:0) |> \n  View()\n  \ntrain <- forecast_tsbl[]\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#impute\nforecast_tsbl |> filter(is.na(observed_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 47,744 x 10 [1D]\n# Key:       city, state, high_or_low, forecast_hours_before [1,336]\n   date       city    state high_or_low foreca…¹ obser…² forec…³ obser…⁴ forec…⁵\n   <date>     <fct>   <fct> <fct>       <fct>      <dbl>   <dbl>   <dbl> <chr>  \n 1 2021-08-04 ABILENE TX    high        12            NA      90      NA PTCLDY \n 2 2021-08-05 ABILENE TX    high        12            NA      91      NA TSTRMS \n 3 2021-08-06 ABILENE TX    high        12            NA      95      NA SUNNY  \n 4 2021-08-07 ABILENE TX    high        12            NA      96      NA SUNNY  \n 5 2021-08-08 ABILENE TX    high        12            NA      99      NA SUNNY  \n 6 2021-08-09 ABILENE TX    high        12            NA     100      NA SUNNY  \n 7 2021-09-29 ABILENE TX    high        12            NA      92      NA TSTRMS \n 8 2021-10-02 ABILENE TX    high        12            NA      82      NA PTCLDY \n 9 2021-10-04 ABILENE TX    high        12            NA      86      NA SUNNY  \n10 2021-10-06 ABILENE TX    high        12            NA      86      NA PTCLDY \n# … with 47,734 more rows, 1 more variable: possible_error <chr>, and\n#   abbreviated variable names ¹​forecast_hours_before, ²​observed_temp,\n#   ³​forecast_temp, ⁴​observed_precip, ⁵​forecast_outlook\n```\n:::\n\n```{.r .cell-code}\nforecast_tsbl |> filter(is.na(forecast_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 37,313 x 10 [1D]\n# Key:       city, state, high_or_low, forecast_hours_before [1,336]\n   date       city    state high_or_low foreca…¹ obser…² forec…³ obser…⁴ forec…⁵\n   <date>     <fct>   <fct> <fct>       <fct>      <dbl>   <dbl>   <dbl> <chr>  \n 1 2021-02-17 ABILENE TX    high        12            20      NA    0    <NA>   \n 2 2021-08-22 ABILENE TX    high        12            97      NA    0    <NA>   \n 3 2021-08-23 ABILENE TX    high        12            97      NA    0    <NA>   \n 4 2021-08-24 ABILENE TX    high        12            98      NA    0    <NA>   \n 5 2021-09-30 ABILENE TX    high        12            88      NA    2.18 <NA>   \n 6 2021-10-03 ABILENE TX    high        12            85      NA    0    <NA>   \n 7 2021-10-05 ABILENE TX    high        12            87      NA    0    <NA>   \n 8 2021-10-07 ABILENE TX    high        12            93      NA    0    <NA>   \n 9 2021-11-11 ABILENE TX    high        12            68      NA    0    <NA>   \n10 2022-01-10 ABILENE TX    high        12            NA      NA   NA    <NA>   \n# … with 37,303 more rows, 1 more variable: possible_error <chr>, and\n#   abbreviated variable names ¹​forecast_hours_before, ²​observed_temp,\n#   ³​forecast_temp, ⁴​observed_precip, ⁵​forecast_outlook\n```\n:::\n\n```{.r .cell-code}\nforecast_tsbl |> \n  filter(city == \"NEWARK\") |> \n  select(observed_temp, forecast_temp) |> \n  #keys and index are automatically kept even when not specified\n  summarise(avg_obs_temp = mean(observed_temp, na.rm = TRUE),\n            avg_pred_temp = mean(forecast_temp, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tsibble: 488 x 3 [1D]\n   date       avg_obs_temp avg_pred_temp\n   <date>            <dbl>         <dbl>\n 1 2021-01-30         26.5          21.7\n 2 2021-01-31         24            27.4\n 3 2021-02-01         30.5          29.5\n 4 2021-02-02         31.5          30.8\n 5 2021-02-03         33.5          31.4\n 6 2021-02-04         36.5          35.8\n 7 2021-02-05         38            36.1\n 8 2021-02-06         37            34.4\n 9 2021-02-07         25            26.2\n10 2021-02-08         24.5          26.1\n# … with 478 more rows\n```\n:::\n\n```{.r .cell-code}\nforecast_tsbl |> \n  filter(city == \"NEWARK\", high_or_low == \"high\") |> \n  select(observed_temp, forecast_temp) |> \n  autoplot(observed_temp)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 8 rows containing missing values (`geom_line()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nforecast_tsbl |>\n  filter(city %in% c(\"NEWARK\", \"ABILENE\")) |> \n  features(observed_temp, feat_stl) |> \n  ggplot(aes(x = trend_strength, y = seasonal_strength_week, color = forecast_hours_before)) +\n  geom_point() + \n  facet_wrap(~city + high_or_low)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/MAE-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n## Fit an ARIMA model on the data with missing values and interpolate\n#Observed temp\nforecast_fill <- forecast_tsbl |> \n  filter(\n    city == \"NEWARK\",\n    state == \"NJ\"\n  ) |> \n  model(\n    ARIMA(observed_temp)\n  ) |> \n  interpolate(forecast_tsbl)\n\n# forecast_fill |> (\\(x) {sum(is.na(x$observed_temp))})()\n# forecast_fill |> with(sum(is.na(observed_temp)))\n\nsum(is.na(forecast_tsbl$observed_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 47744\n```\n:::\n\n```{.r .cell-code}\nsum(is.na(forecast_fill$observed_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0\n```\n:::\n\n```{.r .cell-code}\n#STL Decomposition\n\nforecast_fill |> \n  gg_season(observed_temp)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/observed temp-1.png){width=672}\n:::\n\n```{.r .cell-code}\nforecast_fill |> \n  ACF(observed_temp) |> \n  autoplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/observed temp-2.png){width=672}\n:::\n\n```{.r .cell-code}\nforecast_fill |> \n  model(\n    STL(observed_temp ~ trend(window = 7) + season(period = 365.24, window = 11),\n        robust = FALSE)\n  ) |> \n  components() |> \n  autoplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/observed temp-3.png){width=672}\n:::\n\n```{.r .cell-code}\nforecast_fill |> \n  model(\n    STL(observed_temp ~ trend(window = 7) + season(period = 365.24, window = 13))\n  ) |> \n  components() |> \n  autoplot()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/observed temp-4.png){width=672}\n:::\n\n```{.r .cell-code}\nfit_ets <- forecast_fill |> \n  model(\n    auto_ets = ETS(observed_temp)\n  )\n\nfit_ets |> filter(high_or_low == 'high', forecast_hours_before == 12) |> report()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSeries: observed_temp \nModel: ETS(A,N,N) \n  Smoothing parameters:\n    alpha = 0.5071176 \n\n  Initial states:\n     l[0]\n 32.00149\n\n  sigma^2:  75.0504\n\n     AIC     AICc      BIC \n5132.132 5132.181 5144.703 \n```\n:::\n\n```{.r .cell-code}\nfit_ets |> filter(high_or_low == 'high', forecast_hours_before == 12) |> forecast(h = \"30 days\") |> autoplot(forecast_fill |> filter(high_or_low == 'high', forecast_hours_before == 12), level = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/observed temp-5.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnewark_high_feats <- forecast_fill |> \n  filter(high_or_low == \"high\") |> \n  features(observed_temp, feature_set(pkgs = \"feasts\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: `n_flat_spots()` was deprecated in feasts 0.1.5.\nℹ Please use `longest_flat_spot()` instead.\nℹ The deprecated feature was likely used in the fabletools package.\n  Please report the issue at <https://github.com/tidyverts/fabletools/issues>.\n```\n:::\n\n```{.r .cell-code}\nnewark_high_feats |> \n  select(starts_with(\"season\"), forecast_hours_before) |> \n  mutate(seasonal_peak_week)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 4 × 6\n  seasonal_strength_week seasonal_peak_week seasonal_t…¹ seaso…² seaso…³ forec…⁴\n                   <dbl>              <dbl>        <dbl>   <dbl>   <dbl> <fct>  \n1                  0.186                  5            1   0.745   0.100 12     \n2                  0.186                  5            1   0.745   0.100 24     \n3                  0.186                  5            1   0.745   0.100 36     \n4                  0.186                  5            1   0.745   0.100 48     \n# … with abbreviated variable names ¹​seasonal_trough_week, ²​season_acf1,\n#   ³​season_pacf, ⁴​forecast_hours_before\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnewark_high <- forecast_fill |> \n  filter(high_or_low == \"high\", forecast_hours_before == 12) \n\nnewark_high |> autoplot(observed_temp)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\nnewark_high |> gg_season(observed_temp, labels = \"both\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\nnewark_high |> gg_tsdisplay()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nPlot variable not specified, automatically selected `y = observed_temp`\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-3.png){width=672}\n:::\n\n```{.r .cell-code}\nnewark_high |> gg_tsdisplay(difference(observed_temp, 365) |> difference(),\n                            plot_type = \"partial\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 366 rows containing missing values (`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 366 rows containing missing values (`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-4.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}